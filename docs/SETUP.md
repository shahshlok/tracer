# Setup Guide

This guide will help you set up the EME Testing database system from scratch.

## Prerequisites

### 1. Python 3.10+

Check your Python version:
```bash
python3 --version
```

Should show Python 3.10 or higher.

### 2. SQLite 3.51.0+

Check your SQLite version:
```bash
sqlite3 --version
```

Should show `3.51.0` or higher (released November 2025).

#### Upgrading SQLite

**macOS** (using Homebrew):
```bash
brew upgrade sqlite
```

**Ubuntu/Debian**:
```bash
sudo apt update
sudo apt upgrade sqlite3
```

**From source** (if needed):
```bash
wget https://www.sqlite.org/2025/sqlite-autoconf-3510000.tar.gz
tar xvfz sqlite-autoconf-3510000.tar.gz
cd sqlite-autoconf-3510000
./configure
make
sudo make install
```

### 3. uv Package Manager

Install uv (recommended for November 2025):
```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Or using Homebrew
brew install uv

# Verify installation
uv --version
```

## Installation

### Step 1: Clone/Navigate to Project

```bash
cd "/Users/Shlok/Seventh Term/Honours/EME_testing"
```

### Step 2: Install Dependencies with uv

```bash
# Install all dependencies
uv sync

# Or install dependencies only (without creating virtual env)
uv pip install -e .
```

This will install:
- `jsonschema` - JSON schema validation
- `openai` - OpenAI API client (for evaluation generation)
- `python-dotenv` - Environment variable management
- `rich` - Terminal formatting
- `typer` - CLI framework

### Step 3: Verify Installation

```bash
# Check that the db module is importable
python3 -c "import db; print('✓ Database module loaded')"

# Check SQLite version from Python
python3 -c "import sqlite3; print(f'SQLite version: {sqlite3.sqlite_version}')"
```

Expected output:
```
✓ Database module loaded
SQLite version: 3.51.0
```

## Quick Start

### 1. Initialize Database

```bash
python3 run_loader.py data/ --init-db
```

This will:
- Create `evaluations.db` in the current directory
- Load the schema from `db/schema.sql`
- Load all JSON files from `data/` directory
- Validate all data before insertion

Expected output:
```
Initializing database schema from .../db/schema.sql...
✓ Database schema initialized

Loading: results_direct_2025-11-13T17-52-45.json
  Timestamp: 2025-11-13T17:52:45
  Strategy: direct
  Validating 10 records...
✓ Inserted 10 record(s)

...

======================================================================
LOADING SUMMARY
======================================================================
Files processed: 3/3
Records inserted: 30/30
======================================================================
```

### 2. Validate Data (Optional)

Before loading, you can validate individual files:

```bash
python3 validate_data.py data/results_direct_2025-11-13T17-52-45.json
```

Expected output:
```
Validating: data/results_direct_2025-11-13T17-52-45.json
----------------------------------------------------------------------
✓ Validation passed
```

### 3. Run Analysis

```bash
python3 run_analyzer.py
```

This runs a demonstration of all query types:
- Strategy comparisons
- Model agreement analysis
- Aggregate statistics
- Misconception discovery
- Temporal trends

## Directory Structure

After setup, your project should look like:

```
EME_testing/
├── db/                     # Database module (modular and maintainable)
│   ├── __init__.py        # Package exports
│   ├── schema.sql         # SQLite schema
│   ├── models.py          # Data models
│   ├── validator.py       # Validation logic
│   ├── loader.py          # Data loading
│   └── analyzer.py        # Query and analysis
├── docs/                   # Documentation
│   ├── DATABASE.md        # Architecture and technical details
│   ├── SETUP.md           # This file
│   └── USAGE.md           # Usage examples and guides
├── data/                   # Evaluation JSON files
│   ├── results_direct_*.json
│   ├── results_reverse_*.json
│   └── results_eme_*.json
├── evaluation_schema.json  # JSON schema for validation
├── pyproject.toml         # Project configuration (uv)
├── uv.lock               # Lock file (auto-generated by uv)
├── validate_data.py       # CLI: Validation
├── run_loader.py          # CLI: Data loading
├── run_analyzer.py        # CLI: Analysis
├── evaluations.db         # SQLite database (created after init)
└── README.md             # Project overview
```

## Configuration

### Environment Variables

Create a `.env` file for any configuration:

```bash
# .env
DATABASE_PATH=evaluations.db
SQLITE_MIN_VERSION=3.51.0
```

### Python Path

If you're running scripts from different directories, ensure the project root is in `PYTHONPATH`:

```bash
export PYTHONPATH="/Users/Shlok/Seventh Term/Honours/EME_testing:$PYTHONPATH"
```

Or install the package in editable mode:

```bash
uv pip install -e .
```

## Usage Examples

### Load Data from Specific Directory

```bash
python3 run_loader.py path/to/data/ --db custom.db --init-db
```

### Load Single File

```bash
python3 run_loader.py data/results_direct_2025-11-13T17-52-45.json --db evaluations.db
```

### Validate Without Loading

```bash
python3 validate_data.py data/results_direct_2025-11-13T17-52-45.json
```

### Run Specific Analysis

```bash
# Find model disagreements with custom threshold
python3 run_analyzer.py --query disagreements --threshold 15

# Compare strategies for specific student
python3 run_analyzer.py --query strategies --student "Smith_John_123456"

# Analyze specific run
python3 run_analyzer.py --run-id 1
```

## Development Setup

### Install Development Dependencies

```bash
uv sync --extra dev
```

This installs:
- `pytest` - Testing framework
- `black` - Code formatter
- `ruff` - Fast linter

### Run Tests (if available)

```bash
pytest
```

### Format Code

```bash
black db/ *.py
```

### Lint Code

```bash
ruff check db/ *.py
```

## Programmatic Usage

### As a Library

```python
from db import EvaluationLoader, EvaluationAnalyzer

# Load data
with EvaluationLoader("evaluations.db") as loader:
    loader.init_database()
    loader.load_evaluation_file("data/results_direct_2025-11-13T17-52-45.json")

# Analyze data
with EvaluationAnalyzer("evaluations.db") as analyzer:
    results = analyzer.find_model_disagreements(threshold=10.0)
    for row in results:
        print(f"{row['student_name']}: {row['diff_pct']}% difference")
```

### Custom Validation

```python
from db import EvaluationValidator

validator = EvaluationValidator()
result = validator.validate_evaluation(evaluation_data)

if not result.is_valid:
    print("Validation errors:")
    for error in result.errors:
        print(f"  - {error}")
```

### Direct Database Access

```python
import sqlite3

conn = sqlite3.connect("evaluations.db")
cursor = conn.cursor()

# Query using virtual columns
cursor.execute("""
    SELECT student_name, strategy, avg_pct
    FROM evaluations
    WHERE avg_pct > 80
    ORDER BY avg_pct DESC
""")

for row in cursor.fetchall():
    print(row)

conn.close()
```

## Troubleshooting

### Issue: "ModuleNotFoundError: No module named 'db'"

**Solution**:
```bash
# Ensure you're in the project root
cd "/Users/Shlok/Seventh Term/Honours/EME_testing"

# Install in editable mode
uv pip install -e .
```

### Issue: "no such function: jsonb"

**Solution**: Your SQLite version is too old. Upgrade to 3.51.0+:
```bash
brew upgrade sqlite  # macOS
```

### Issue: "jsonschema package not found"

**Solution**:
```bash
uv add jsonschema
```

### Issue: Database locked

**Solution**: Another process is using the database. Close it:
```bash
# Find processes using the database
lsof evaluations.db

# Kill if needed
kill <PID>
```

### Issue: Permission denied

**Solution**: Ensure you have write permissions:
```bash
chmod 644 evaluations.db
```

## Next Steps

- Read [USAGE.md](USAGE.md) for detailed usage examples
- Read [DATABASE.md](DATABASE.md) for technical architecture details
- Explore the `db/` module for customization
- Create custom analysis scripts using the `EvaluationAnalyzer` class

## Support

For issues or questions:
1. Check the [Troubleshooting](#troubleshooting) section
2. Review [DATABASE.md](DATABASE.md) for technical details
3. Consult the inline documentation in `db/` modules
